<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a1628">
<title>FDA Watch — Drug Safety & Food Recall Chat</title>
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRkRBIFdhdGNoIiwic2hvcnRfbmFtZSI6IkZEQSBXYXRjaCIsInN0YXJ0X3VybCI6Ii4vIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzBhMTYyOCIsInRoZW1lX2NvbG9yIjoiIzBhMTYyOCJ9">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-deep: #0a1628;
    --bg-surface: #111d33;
    --bg-card: #162240;
    --bg-input: #1a2847;
    --accent: #00d4aa;
    --accent-dim: #00a888;
    --accent-glow: rgba(0, 212, 170, 0.15);
    --warning: #ff6b4a;
    --warning-dim: rgba(255, 107, 74, 0.12);
    --text-primary: #e8edf5;
    --text-secondary: #8899b4;
    --text-dim: #556a8a;
    --border: rgba(255,255,255,0.06);
    --border-accent: rgba(0, 212, 170, 0.25);
    --radius: 16px;
    --radius-sm: 10px;
    --font: 'DM Sans', -apple-system, sans-serif;
    --mono: 'JetBrains Mono', monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  html, body {
    height: 100%; overflow: hidden;
    font-family: var(--font);
    background: var(--bg-deep);
    color: var(--text-primary);
    -webkit-font-smoothing: antialiased;
  }

  .app {
    display: flex; flex-direction: column;
    height: 100vh; height: 100dvh;
    max-width: 520px; margin: 0 auto;
    position: relative;
  }

  /* ── Header ── */
  .header {
    flex-shrink: 0;
    padding: 16px 20px 12px;
    background: linear-gradient(180deg, var(--bg-deep) 0%, transparent 100%);
    position: relative; z-index: 10;
    border-bottom: 1px solid var(--border);
  }
  .header-top {
    display: flex; align-items: center; justify-content: space-between;
  }
  .logo {
    display: flex; align-items: center; gap: 10px;
  }
  .logo-icon {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--accent) 0%, #00b89c 100%);
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; font-weight: 700; color: var(--bg-deep);
    box-shadow: 0 4px 20px rgba(0, 212, 170, 0.3);
  }
  .logo-text {
    font-size: 18px; font-weight: 700;
    letter-spacing: -0.3px;
  }
  .logo-text span { color: var(--accent); }
  .header-badge {
    font-size: 10px; font-weight: 600;
    color: var(--accent);
    background: var(--accent-glow);
    padding: 4px 10px; border-radius: 20px;
    letter-spacing: 0.5px; text-transform: uppercase;
    border: 1px solid var(--border-accent);
  }
  .header-sub {
    font-size: 12px; color: var(--text-dim);
    margin-top: 6px; padding-left: 46px;
  }

  /* ── Chat Area ── */
  .chat-area {
    flex: 1; overflow-y: auto; overflow-x: hidden;
    padding: 16px 16px 8px;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
  }
  .chat-area::-webkit-scrollbar { width: 3px; }
  .chat-area::-webkit-scrollbar-thumb { background: var(--text-dim); border-radius: 4px; }

  /* ── Messages ── */
  .message {
    display: flex; gap: 10px;
    margin-bottom: 16px;
    animation: msgIn 0.35s cubic-bezier(0.22, 1, 0.36, 1) both;
  }
  @keyframes msgIn {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .message.user { flex-direction: row-reverse; }

  .msg-avatar {
    width: 30px; height: 30px; flex-shrink: 0;
    border-radius: 9px;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 600;
    margin-top: 2px;
  }
  .message.bot .msg-avatar {
    background: linear-gradient(135deg, var(--accent) 0%, #00b89c 100%);
    color: var(--bg-deep);
  }
  .message.user .msg-avatar {
    background: var(--bg-card);
    color: var(--text-secondary);
    border: 1px solid var(--border);
  }

  .msg-content { max-width: 82%; }
  .msg-bubble {
    padding: 12px 16px;
    font-size: 14px; line-height: 1.6;
    border-radius: var(--radius);
  }
  .message.bot .msg-bubble {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-top-left-radius: 4px;
    color: var(--text-primary);
  }
  .message.user .msg-bubble {
    background: linear-gradient(135deg, rgba(0,212,170,0.15) 0%, rgba(0,184,156,0.08) 100%);
    border: 1px solid var(--border-accent);
    border-top-right-radius: 4px;
    color: var(--text-primary);
  }
  .msg-time {
    font-size: 10px; color: var(--text-dim);
    margin-top: 4px; padding: 0 4px;
  }
  .message.user .msg-time { text-align: right; }

  /* ── Data Cards ── */
  .data-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 14px;
    margin-top: 10px;
  }
  .data-card-header {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 10px;
    font-size: 11px; font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--accent);
  }
  .data-card-header .dot {
    width: 6px; height: 6px;
    background: var(--accent);
    border-radius: 50%;
    animation: pulse 2s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 0.4; }
    50% { opacity: 1; }
  }
  .data-row {
    display: flex; justify-content: space-between; align-items: baseline;
    padding: 6px 0;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
  }
  .data-row:last-child { border-bottom: none; }
  .data-label { color: var(--text-secondary); }
  .data-value { font-weight: 600; font-family: var(--mono); font-size: 12px; }
  .data-value.high { color: var(--warning); }
  .data-value.ok { color: var(--accent); }

  /* ── Bar Chart ── */
  .mini-chart { margin-top: 10px; }
  .chart-bar-row {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 6px; font-size: 11px;
  }
  .chart-label {
    width: 90px; flex-shrink: 0;
    color: var(--text-secondary);
    text-align: right;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .chart-track {
    flex: 1; height: 18px;
    background: rgba(255,255,255,0.03);
    border-radius: 4px; overflow: hidden;
    position: relative;
  }
  .chart-fill {
    height: 100%; border-radius: 4px;
    background: linear-gradient(90deg, var(--accent) 0%, rgba(0,212,170,0.5) 100%);
    transition: width 1s cubic-bezier(0.22, 1, 0.36, 1);
  }
  .chart-fill.warn {
    background: linear-gradient(90deg, var(--warning) 0%, rgba(255,107,74,0.5) 100%);
  }
  .chart-num {
    width: 48px; flex-shrink: 0;
    font-family: var(--mono); font-size: 11px;
    color: var(--text-dim); text-align: right;
  }

  /* ── Quick Actions ── */
  .quick-actions {
    display: flex; gap: 8px; flex-wrap: wrap;
    margin-top: 12px;
  }
  .quick-btn {
    background: var(--bg-card);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    padding: 8px 14px;
    border-radius: 20px;
    font-size: 12px; font-family: var(--font);
    cursor: pointer;
    transition: all 0.2s;
  }
  .quick-btn:hover, .quick-btn:active {
    background: var(--accent-glow);
    border-color: var(--border-accent);
    color: var(--accent);
  }

  /* ── Typing Indicator ── */
  .typing { display: flex; gap: 4px; padding: 8px 0; }
  .typing-dot {
    width: 7px; height: 7px;
    background: var(--accent);
    border-radius: 50%;
    animation: typeBounce 1.4s ease-in-out infinite;
  }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes typeBounce {
    0%, 60%, 100% { transform: translateY(0); opacity: 0.3; }
    30% { transform: translateY(-6px); opacity: 1; }
  }

  /* ── Input Area ── */
  .input-area {
    flex-shrink: 0;
    padding: 12px 16px 16px;
    background: var(--bg-surface);
    border-top: 1px solid var(--border);
  }
  .input-row {
    display: flex; align-items: flex-end; gap: 8px;
  }
  .input-wrap {
    flex: 1;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 24px;
    display: flex; align-items: flex-end;
    padding: 4px 4px 4px 16px;
    transition: border-color 0.2s;
  }
  .input-wrap:focus-within {
    border-color: var(--border-accent);
  }
  #msgInput {
    flex: 1; border: none; outline: none;
    background: transparent;
    color: var(--text-primary);
    font-family: var(--font);
    font-size: 14px;
    padding: 8px 0;
    resize: none;
    max-height: 100px;
    line-height: 1.4;
  }
  #msgInput::placeholder { color: var(--text-dim); }

  .btn-icon {
    width: 36px; height: 36px; flex-shrink: 0;
    border: none; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.2s;
  }
  .btn-mic {
    background: transparent;
    color: var(--text-secondary);
  }
  .btn-mic:hover { color: var(--accent); }
  .btn-mic.recording {
    background: rgba(255, 74, 74, 0.15);
    color: #ff4a4a;
    animation: recPulse 1s ease-in-out infinite;
  }
  @keyframes recPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(255,74,74,0.3); }
    50% { box-shadow: 0 0 0 8px rgba(255,74,74,0); }
  }
  .btn-send {
    background: linear-gradient(135deg, var(--accent) 0%, #00b89c 100%);
    color: var(--bg-deep);
  }
  .btn-send:hover { transform: scale(1.05); }
  .btn-send:active { transform: scale(0.95); }
  .btn-send:disabled {
    opacity: 0.3; cursor: default; transform: none;
  }

  .input-hint {
    font-size: 10px; color: var(--text-dim);
    text-align: center; margin-top: 8px;
  }
  .input-hint a { color: var(--accent-dim); text-decoration: none; }

  /* ── Error banner ── */
  .error-banner {
    background: var(--warning-dim);
    border: 1px solid rgba(255,107,74,0.3);
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    margin-top: 8px;
    font-size: 12px;
    color: #d4937f;
  }

  /* ── Disclaimer ── */
  .disclaimer {
    background: var(--warning-dim);
    border: 1px solid rgba(255,107,74,0.2);
    border-radius: var(--radius-sm);
    padding: 10px 14px;
    margin-bottom: 14px;
    font-size: 11px; line-height: 1.5;
    color: #d4937f;
  }
  .disclaimer strong { color: var(--warning); }

  /* ── Loading status ── */
  .data-status {
    font-size: 11px; color: var(--text-dim);
    text-align: center; padding: 8px;
  }
  .data-status.loaded { color: var(--accent); }
  .data-status.error { color: var(--warning); }

  @media (min-width: 521px) {
    .app {
      border-left: 1px solid var(--border);
      border-right: 1px solid var(--border);
    }
  }

  body::before {
    content: '';
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: radial-gradient(ellipse at 20% 0%, rgba(0,212,170,0.04) 0%, transparent 60%),
                radial-gradient(ellipse at 80% 100%, rgba(0,130,255,0.03) 0%, transparent 60%);
    pointer-events: none; z-index: 0;
  }
  .app { position: relative; z-index: 1; }
</style>
</head>
<body>
<div class="app">
  <!-- Header -->
  <div class="header">
    <div class="header-top">
      <div class="logo">
        <div class="logo-icon">Rx</div>
        <div class="logo-text">FDA <span>Watch</span></div>
      </div>
      <div class="header-badge">Live Data</div>
    </div>
    <div class="header-sub">Drug safety &amp; food recall intelligence — powered by openFDA</div>
  </div>

  <!-- Chat -->
  <div class="chat-area" id="chatArea">

    <div class="disclaimer">
      <strong>⚠ Not medical advice.</strong> FDA Watch uses public FDA data to answer questions. Always consult your healthcare provider about medication risks.
    </div>

    <!-- Welcome message -->
    <div class="message bot" style="animation-delay: 0.1s">
      <div class="msg-avatar">Rx</div>
      <div class="msg-content">
        <div class="msg-bubble">
          Hey there! I'm <strong>FDA Watch</strong> — your conversational guide to U.S. drug safety reports and food recalls.<br><br>
          I pull from the <strong>openFDA</strong> database, which tracks millions of adverse event reports and recall notices. Ask me anything — type or tap the mic.
        </div>
        <div class="quick-actions" id="quickActions">
          <button class="quick-btn" onclick="sendQuick(this)">What are the most reported drug side effects?</button>
          <button class="quick-btn" onclick="sendQuick(this)">Tell me about metformin safety</button>
          <button class="quick-btn" onclick="sendQuick(this)">Which drugs have the most reports?</button>
          <button class="quick-btn" onclick="sendQuick(this)">Show me outcome severity data</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Input -->
  <div class="input-area">
    <div class="input-row">
      <div class="input-wrap">
        <textarea id="msgInput" rows="1" placeholder="Ask about drug safety or food recalls…" onkeydown="handleKey(event)" oninput="autoGrow(this)"></textarea>
        <button class="btn-icon btn-mic" id="micBtn" onclick="toggleMic()" title="Voice input">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
            <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
            <line x1="12" y1="19" x2="12" y2="23"/>
            <line x1="8" y1="23" x2="16" y2="23"/>
          </svg>
        </button>
      </div>
      <button class="btn-icon btn-send" id="sendBtn" onclick="sendMessage()" disabled title="Send">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"/>
          <polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </div>
    <div class="input-hint">
      openFDA public data · <a href="https://open.fda.gov" target="_blank">Source</a> · Not for clinical decisions
    </div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════════════════
// FDA Watch — Production Chat with Gemini API
// ═══════════════════════════════════════════════════════════

// ═══════════════════════════════════════════════════════════
// MODEL CONFIGURATION — Edit this section to switch providers
// ═══════════════════════════════════════════════════════════
// Set ACTIVE_PROVIDER to one of: "gemini", "gemini-lite", "minimax"
// Then paste the matching API key below.

const ACTIVE_PROVIDER = "gemini-lite";  // ← CHANGE THIS TO SWITCH

const PROVIDERS = {
  // Google Gemini 2.0 Flash — smart, but free tier is very limited (Dec 2025 cuts)
  "gemini": {
    name: "Gemini 2.0 Flash",
    key: "AIzaSyBsLauPGGNiyVHvDhsiKWmoIntOo_nUd7o",           // ← paste Gemini key
    model: "gemini-2.0-flash",
    type: "gemini"
  },
  // Google Gemini 2.0 Flash-Lite — less capable but ~1000 req/day on free tier
  "gemini-lite": {
    name: "Gemini 2.0 Flash-Lite",
    key: "AIzaSyBsLauPGGNiyVHvDhsiKWmoIntOo_nUd7o",           // ← same Gemini key works
    model: "gemini-2.0-flash-lite",
    type: "gemini"
  },
  // MiniMax M2.5 — OpenAI-compatible, 20 RPM free tier, very capable
  "minimax": {
    name: "MiniMax M2.5",
    key: "YOUR_MINIMAX_KEY_HERE",          // ← paste MiniMax key from platform.minimax.io
    model: "MiniMax-M2.5",
    type: "openai-compatible",
    baseUrl: "https://api.minimax.io/v1/chat/completions"
  }
};

const provider = PROVIDERS[ACTIVE_PROVIDER];
// ═══════════════════════════════════════════════════════════

// ── DOM refs ──
const chatArea = document.getElementById('chatArea');
const msgInput = document.getElementById('msgInput');
const sendBtn = document.getElementById('sendBtn');
const micBtn = document.getElementById('micBtn');

let isRecording = false;
let recognition = null;
let conversationHistory = [];
let fdaData = null;
let drugProfiles = {};

// ── Load FDA data on startup ──
async function loadFDAData() {
  try {
    // Load the summary data
    const summaryResp = await fetch('./data/summary.json');
    if (!summaryResp.ok) throw new Error('Could not load summary.json');
    fdaData = await summaryResp.json();

    // Try to load individual drug profiles
    const drugNames = ['metformin', 'aspirin', 'ibuprofen', 'lisinopril',
                       'atorvastatin', 'levothyroxine', 'amlodipine',
                       'omeprazole', 'acetaminophen'];

    const drugPromises = drugNames.map(async (name) => {
      try {
        const resp = await fetch(`./data/drug_${name}.json`);
        if (resp.ok) {
          drugProfiles[name] = await resp.json();
        }
      } catch (e) {
        // Drug file not available — that's fine
      }
    });

    await Promise.all(drugPromises);

    console.log('FDA data loaded:', {
      summary: !!fdaData,
      drugs: Object.keys(drugProfiles)
    });

  } catch (err) {
    console.error('Error loading FDA data:', err);
    addBotMessage(
      `<div class="error-banner">⚠ Could not load FDA data files. Make sure the <code>data/</code> folder with your JSON files is in the same directory as this HTML file.</div>`
    );
  }
}

// ── Build system prompt with FDA data context ──
function buildSystemPrompt() {
  let prompt = `You are FDA Watch, a knowledgeable and conversational assistant that helps people understand U.S. drug safety reports and food recall data from the openFDA database.

PERSONALITY:
- Friendly, clear, and direct
- You explain medical/safety data in plain language
- You always remind users this is not medical advice when discussing specific drugs
- You present data accurately and note important caveats (e.g., reporting bias, correlation vs causation)

FORMATTING RULES — CRITICAL:
- Your responses will be rendered as HTML inside a chat bubble
- Use <strong> for emphasis, <br> for line breaks
- Keep responses concise — this is a chat, not an essay
- When presenting data, use natural language, not tables
- If you mention specific numbers from the data, be precise

AVAILABLE DATA:
`;

  if (fdaData) {
    prompt += `\nSUMMARY DATA (generated ${fdaData.generated || 'recently'}):\n`;

    if (fdaData.top_reactions) {
      prompt += `\nTop Adverse Reactions (across all drugs):\n`;
      fdaData.top_reactions.forEach(r => {
        prompt += `- ${r.reaction}: ${r.count?.toLocaleString() || r.count} reports (${r.pct_of_max}% of max)\n`;
      });
    }

    if (fdaData.top_drugs) {
      prompt += `\nTop Drugs by Adverse Event Reports:\n`;
      fdaData.top_drugs.forEach(d => {
        prompt += `- ${d.drug || d.term}: ${d.count?.toLocaleString() || d.count} reports\n`;
      });
    }

    if (fdaData.outcomes) {
      prompt += `\nOutcome Severity Breakdown:\n`;
      fdaData.outcomes.forEach(o => {
        prompt += `- ${o.outcome || o.term}: ${o.count?.toLocaleString() || o.count} reports\n`;
      });
    }

    if (fdaData.by_country) {
      prompt += `\nReports by Country (top entries):\n`;
      fdaData.by_country.slice(0, 10).forEach(c => {
        prompt += `- ${c.country || c.term}: ${c.count?.toLocaleString() || c.count} reports\n`;
      });
    }
  }

  // Add individual drug profiles
  const drugKeys = Object.keys(drugProfiles);
  if (drugKeys.length > 0) {
    prompt += `\nINDIVIDUAL DRUG PROFILES AVAILABLE: ${drugKeys.join(', ')}\n`;
    drugKeys.forEach(name => {
      const d = drugProfiles[name];
      prompt += `\n--- ${name.toUpperCase()} ---\n`;
      prompt += JSON.stringify(d, null, 0).substring(0, 1500) + '\n';
    });
  }

  prompt += `\nIf asked about something not in this data, say so honestly and suggest what you CAN help with. Do not fabricate data.`;

  return prompt;
}

// ── Call AI (supports Gemini and OpenAI-compatible providers) ──
async function callAI(userMessage) {
  // Check for placeholder keys
  if (!provider.key || provider.key.startsWith("YOUR_")) {
    return `⚠ <strong>API key not configured for ${provider.name}.</strong> Open this HTML file, find the PROVIDERS section near the top, and paste your API key for <code>${ACTIVE_PROVIDER}</code>.`;
  }

  const systemPrompt = buildSystemPrompt();

  if (provider.type === "gemini") {
    return await callGeminiAPI(userMessage, systemPrompt);
  } else {
    return await callOpenAICompatibleAPI(userMessage, systemPrompt);
  }
}

// ── Gemini-specific call ──
async function callGeminiAPI(userMessage, systemPrompt) {
  const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/${provider.model}:generateContent?key=${provider.key}`;

  conversationHistory.push({ role: "user", parts: [{ text: userMessage }] });
  const recentHistory = conversationHistory.slice(-40);

  const body = {
    system_instruction: { parts: [{ text: systemPrompt }] },
    contents: recentHistory,
    generationConfig: { temperature: 0.7, maxOutputTokens: 1024, topP: 0.9 },
    safetySettings: [
      { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
      { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
      { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
      { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
    ]
  };

  try {
    const response = await fetch(GEMINI_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });

    if (!response.ok) {
      const errData = await response.json().catch(() => ({}));
      const errMsg = errData?.error?.message || response.statusText;
      console.error('Gemini API error:', errMsg);
      if (response.status === 429) {
        return `⚠ <strong>Rate limit reached (${provider.name}).</strong> Try switching to <code>"gemini-lite"</code> or <code>"minimax"</code> in the ACTIVE_PROVIDER setting — they have higher free tier limits.`;
      }
      return `⚠ <strong>API error (${response.status}):</strong> ${escHtml(errMsg)}`;
    }

    const data = await response.json();
    const reply = data?.candidates?.[0]?.content?.parts?.[0]?.text;

    if (!reply) return "I got an empty response — could you rephrase your question?";

    conversationHistory.push({ role: "model", parts: [{ text: reply }] });
    return reply;

  } catch (err) {
    console.error('Network error:', err);
    return "⚠ <strong>Connection error.</strong> Check your internet connection and try again.";
  }
}

// ── OpenAI-compatible call (MiniMax, etc.) ──
async function callOpenAICompatibleAPI(userMessage, systemPrompt) {
  // Convert Gemini-format history to OpenAI format
  const messages = [{ role: "system", content: systemPrompt }];

  // Add conversation history
  for (const msg of conversationHistory) {
    const role = msg.role === "model" ? "assistant" : msg.role;
    const content = msg.parts ? msg.parts[0].text : msg.content;
    messages.push({ role, content });
  }
  messages.push({ role: "user", content: userMessage });

  // Keep history manageable
  if (messages.length > 42) {
    const system = messages[0];
    messages.splice(1, messages.length - 41);
    messages[0] = system;
  }

  const body = {
    model: provider.model,
    messages: messages,
    temperature: 0.7,
    max_tokens: 1024
  };

  try {
    const response = await fetch(provider.baseUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${provider.key}`
      },
      body: JSON.stringify(body)
    });

    if (!response.ok) {
      const errData = await response.json().catch(() => ({}));
      const errMsg = errData?.error?.message || response.statusText;
      console.error(`${provider.name} API error:`, errMsg);
      if (response.status === 429) {
        return `⚠ <strong>Rate limit reached (${provider.name}).</strong> Wait a minute or try a different provider.`;
      }
      return `⚠ <strong>API error (${response.status}):</strong> ${escHtml(errMsg)}`;
    }

    const data = await response.json();
    let reply = data?.choices?.[0]?.message?.content;

    if (!reply) return "I got an empty response — could you rephrase your question?";

    // Strip <think> tags from MiniMax reasoning models
    reply = reply.replace(/<think>[\s\S]*?<\/think>/g, '').trim();

    // Store in Gemini format for history compatibility
    conversationHistory.push({ role: "user", parts: [{ text: userMessage }] });
    conversationHistory.push({ role: "model", parts: [{ text: reply }] });

    return reply;

  } catch (err) {
    console.error('Network error:', err);
    return "⚠ <strong>Connection error.</strong> Check your internet connection and try again.";
  }
}

// ── Input handling ──
msgInput.addEventListener('input', () => {
  sendBtn.disabled = msgInput.value.trim().length === 0;
});

function autoGrow(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function sendQuick(btn) {
  msgInput.value = btn.textContent;
  sendBtn.disabled = false;
  sendMessage();
}

// ── Voice Input (Web Speech API) ──
function toggleMic() {
  if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
    addBotMessage("Voice input isn't supported in this browser. Try Chrome on Android or desktop.");
    return;
  }

  if (isRecording) {
    recognition.stop();
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'en-US';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onstart = () => {
    isRecording = true;
    micBtn.classList.add('recording');
    msgInput.placeholder = 'Listening…';
  };

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    msgInput.value = transcript;
    sendBtn.disabled = false;
    autoGrow(msgInput);
  };

  recognition.onend = () => {
    isRecording = false;
    micBtn.classList.remove('recording');
    msgInput.placeholder = 'Ask about drug safety or food recalls…';
  };

  recognition.onerror = (event) => {
    isRecording = false;
    micBtn.classList.remove('recording');
    msgInput.placeholder = 'Ask about drug safety or food recalls…';
    if (event.error === 'not-allowed') {
      addBotMessage("Microphone access was blocked. Please allow microphone permission in your browser settings.");
    }
  };

  recognition.start();
}

// ── Message rendering ──
function timeStr() {
  return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function addUserMessage(text) {
  const html = `
    <div class="message user">
      <div class="msg-avatar">You</div>
      <div class="msg-content">
        <div class="msg-bubble">${escHtml(text)}</div>
        <div class="msg-time">${timeStr()}</div>
      </div>
    </div>`;
  chatArea.insertAdjacentHTML('beforeend', html);
  scrollBottom();
}

function addBotMessage(html) {
  const msg = `
    <div class="message bot">
      <div class="msg-avatar">Rx</div>
      <div class="msg-content">
        <div class="msg-bubble">${html}</div>
        <div class="msg-time">${timeStr()}</div>
      </div>
    </div>`;
  chatArea.insertAdjacentHTML('beforeend', msg);
  scrollBottom();
}

function showTyping() {
  const id = 'typing-' + Date.now();
  const html = `
    <div class="message bot" id="${id}">
      <div class="msg-avatar">Rx</div>
      <div class="msg-content">
        <div class="msg-bubble">
          <div class="typing">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
        </div>
      </div>
    </div>`;
  chatArea.insertAdjacentHTML('beforeend', html);
  scrollBottom();
  return id;
}

function removeTyping(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
}

function scrollBottom() {
  requestAnimationFrame(() => {
    chatArea.scrollTop = chatArea.scrollHeight;
  });
}

function escHtml(t) {
  const d = document.createElement('div');
  d.textContent = t;
  return d.innerHTML;
}

// ── Send message ──
async function sendMessage() {
  const text = msgInput.value.trim();
  if (!text) return;

  addUserMessage(text);
  msgInput.value = '';
  msgInput.style.height = 'auto';
  sendBtn.disabled = true;

  // Remove quick actions after first use
  const qa = document.getElementById('quickActions');
  if (qa) qa.remove();

  const typingId = showTyping();

  // Call AI with the real data
  const reply = await callAI(text);

  removeTyping(typingId);
  addBotMessage(reply);
}

// ── Initialize ──
loadFDAData();
// Show active provider in header
const badge = document.querySelector('.header-badge');
if (badge) badge.textContent = provider.name;
console.log(`FDA Watch using: ${provider.name} (${ACTIVE_PROVIDER})`);
</script>
</body>
</html>
